<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Metaflow Run</title>
    <style>
      body {
        font-size: 100%;
        font-family: sans-serif;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%;
        overflow: hidden;
      }

      header {
        background: pink;
        height: 65px;
        flex: 0 1 auto;
        flex-grow: none;
        background: #f9f9f9;
        display: flex;
        justify-content: space-evenly;
      }

      header > div {
        padding: 1rem;
        flex: 1;
        display: flex;
        align-items: center;
      }

      header > div:nth-child(2) {
        background: green;
        text-align: center;
        flex: 2;
        justify-content: center;
      }

      header > div:nth-child(3) {
        background: blue;
        text-align: right;
        justify-content: flex-end;
      }

      .content {
        flex: 1 1 auto;
        background: orange;
        overflow-y: scroll;
      }

      iframe {
        background: pink;
        width: 100%;
        height: calc(100vh - 65px);
        outline: none;
        border: 0;
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <img src="" alt="Metaflow" />
        <h1 id="header-title">Metaflow Run</h1>
      </div>
      <div>
        <select name="runSelector" id="selector">
          <option value="1">First</option>
          <option value="2">Second</option>
          <option value="3">Third</option>
        </select>
      </div>
      <div>
        <div id="task-status" class="">Task Completed</div>
        <div id="task-action" class="">Pause</div>
      </div>
    </header>
    <div class="content">
      <iframe id="card-frame"></iframe>
    </div>

    <script>
      (() => {
        // setup constants
        const DATA_UPDATE_POLL_INTERVAL = 5000;
        const RUN_UPDATE_POLL_INTERVAL = 10000;

        // setup DOM elements
        const selector = document.getElementById("selector");
        selector?.addEventListener("change", (event) => {
          selectedCard = event.target.value;
          updateIframe(event.target.name, event.target.value);
        });

        // setup state
        let currentState = "ok";
        let currentCardsLength = 0;
        let selectedCard = "";

        /**
         * Handle any changes to the status of the page
         */
        function handleStatus(status) {
          if (status === "complete") {
            currentState = "complete";
          } else if (status !== "ok") {
            currentState = "error";
          }

          const statusDiv = document.getElementById("task-status");
          if (statusDiv) {
            statusDiv.innerText = status;
            currentState === "error"
              ? statusDiv.classList.add("error")
              : statusDiv.classList.remove("error");
          }
        }

        /**
         * Handle any changes to the cards
         */
        function handleCards(cards) {
          currentCardsLength = cards.length;
          selector.innerHTML = "";

          // create options for each card
          cards.forEach((card) => {
            const option = document.createElement("option");
            option.value = card.card;
            option.innerText = card.label;
            option.selected = card.card === selectedCard;
            selector.appendChild(option);
          });
        }

        /**
         * Update the iframe with the new card
         */
        function updateIframe(name, value) {
          document.getElementsByTagName("title").innerHTML = name;
          const iframe = document.getElementById("card-frame");
          iframe.src = `/card/${value}`;
        }

        /**
         * Main loop function
         */
        async function main() {
          try {
            const runInfoRequest = await fetch("/runinfo");
            const runInfo = await runInfoRequest.json();

            if (runInfo.status !== currentState) {
              handleStatus(runInfo.status);
            }

            if (runInfo?.cards.length !== currentCardsLength) {
              handleCards(runInfo.cards);
            }

            if (!selectedCard) {
              selectedCard = runInfo.cards[0].task;
              updateIframe(runInfo.cards[0].label, runInfo.cards[0].card);
            }

            console.log("runInfo", runInfo);
          } catch (error) {
            console.error(error);
          }

          // only continue polling if the status is ok
          if (status === "ok") {
            setTimeout(main, RUN_UPDATE_POLL_INTERVAL);
          }
        }

        window.onload = () => {
          main();
        };
      })();
    </script>
  </body>
</html>
